<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Ergovia Premium</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="/logo.png" alt="Ergovia" style="width:28px;height:auto;margin-right:4px;">
                <span>Ergovia</span>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
                <a href="settings.html" class="nav-item active">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Settings</span>
                </a>
                <a href="properties.html" class="nav-item">
                    <i class="fas fa-building"></i>
                    <span>Properties</span>
                </a>
            </div>
            <div class="nav-user">
                <div class="notification-bell" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationCount">0</span>
                </div>
                <div class="user-profile">
                    <i class="fas fa-user-circle"></i>
                    <span id="userName">Owner</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p class="progress-text" id="progressText">0% Complete</p>
        </div>

        <!-- n8n Connection Card -->
        <div id="n8nConnectionCard" style="margin-bottom:16px;padding:16px 20px;background:#242526;border-radius:10px;border:1px solid #3a3b3c;">
            <!-- Not connected state -->
            <div id="n8nNotConnected">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <i class="fas fa-plug" style="color:#ff9800;font-size:18px;"></i>
                        <strong style="color:#e4e6eb;">Connect to n8n</strong>
                    </div>
                    <span style="background:#e74c3c;color:#fff;padding:2px 10px;border-radius:12px;font-size:11px;">Not Connected</span>
                </div>
                <p style="color:#8b8d91;font-size:13px;margin-bottom:12px;">Enter your n8n instance URL and API key to enable live workflow sync from this settings page.</p>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
                    <input type="url" id="n8nUrl" placeholder="http://116.203.115.12:5678" style="padding:10px 12px;border-radius:6px;border:1px solid #3a3b3c;background:#18191a;color:#e4e6eb;font-size:13px;">
                    <input type="password" id="n8nApiKey" placeholder="n8n API Key" style="padding:10px 12px;border-radius:6px;border:1px solid #3a3b3c;background:#18191a;color:#e4e6eb;font-size:13px;">
                </div>
                <button type="button" id="n8nConnectBtn" onclick="WorkflowSync.connectN8n()" style="width:100%;padding:10px;border-radius:8px;border:none;background:#ff9800;color:#fff;font-size:14px;font-weight:600;cursor:pointer;">
                    <i class="fas fa-plug"></i> Connect & Import Workflows
                </button>
            </div>

            <!-- Connected state (hidden initially) -->
            <div id="n8nConnected" style="display:none;">
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <i class="fas fa-check-circle" style="color:#42b72a;font-size:20px;"></i>
                        <div>
                            <strong style="color:#e4e6eb;" id="n8nConnectedUrl">Connected to n8n</strong>
                            <div style="color:#42b72a;font-size:12px;" id="n8nConnectedCount">0 workflows linked</div>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="color:#8b8d91;font-size:12px;" id="syncLastStatus"></span>
                        <button type="button" onclick="WorkflowSync.disconnectN8n()" style="padding:4px 12px;border-radius:6px;border:1px solid #3a3b3c;background:transparent;color:#8b8d91;font-size:12px;cursor:pointer;" title="Disconnect">
                            <i class="fas fa-unlink"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sync Banner (hidden by default, shows when changes need sync) -->
        <div id="syncBanner" style="display:none;align-items:center;gap:12px;padding:14px 20px;margin-bottom:16px;background:linear-gradient(135deg,#1877f2,#42a5f5);color:#fff;border-radius:10px;font-size:14px;box-shadow:0 2px 8px rgba(24,119,242,0.3);">
        </div>

        <!-- Form Container -->
        <div class="form-container">
            <h1><i class="fas fa-cog"></i> Property Manager Settings</h1>
            <p class="form-subtitle">Complete all sections to activate your AI assistant</p>

            <form id="fillupForm" onsubmit="return handleFormSubmit(event)">

                <!-- SECTION 1: Owner Information -->
                <div class="form-section">
                    <div class="section-header-form">
                        <h2><i class="fas fa-user"></i> 1. Owner Information</h2>
                        <button type="button" class="btn-help" onclick="showHelp('owner')">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="ownerName">
                                <i class="fas fa-user"></i> Full Name
                                <span class="required">*</span>
                            </label>
                            <input type="text" id="ownerName" name="ownerName" required
                                   placeholder="John Smith">
                        </div>

                        <div class="form-group">
                            <label for="ownerEmail">
                                <i class="fas fa-envelope"></i> Email Address
                                <span class="required">*</span>
                            </label>
                            <input type="email" id="ownerEmail" name="ownerEmail" required
                                   placeholder="john@example.com">
                        </div>

                        <div class="form-group">
                            <label for="ownerPhone">
                                <i class="fas fa-phone"></i> Phone Number
                                <span class="required">*</span>
                            </label>
                            <input type="tel" id="ownerPhone" name="ownerPhone" required
                                   placeholder="+1234567890">
                        </div>

                        <div class="form-group">
                            <label for="preferredPlatform">
                                <i class="fas fa-comments"></i> Preferred Contact Platform
                                <span class="required">*</span>
                            </label>
                            <select id="preferredPlatform" name="preferredPlatform" required>
                                <option value="">Select platform...</option>
                                <option value="telegram">Telegram</option>
                                <option value="whatsapp">WhatsApp</option>
                                <option value="sms">SMS</option>
                            </select>
                        </div>

                        <div class="form-group" id="telegramChatIdGroup" style="display:none;">
                            <label for="telegramChatId">
                                <i class="fab fa-telegram"></i> Telegram Chat ID
                            </label>
                            <input type="text" id="telegramChatId" name="telegramChatId"
                                   placeholder="123456789">
                            <small class="help-text">
                                <a href="#" onclick="showTelegramHelp()">How to find my Chat ID?</a>
                            </small>
                        </div>

                        <div class="form-group" id="whatsappNumberGroup" style="display:none;">
                            <label for="whatsappNumber">
                                <i class="fab fa-whatsapp"></i> WhatsApp Number
                            </label>
                            <input type="tel" id="whatsappNumber" name="whatsappNumber"
                                   placeholder="+1234567890">
                        </div>
                    </div>

                    <button type="button" class="btn-save-section" onclick="saveSection('owner')">
                        <i class="fas fa-save"></i> Save Section
                    </button>
                </div>

                <!-- SECTION 2: API Credentials -->
                <div class="form-section">
                    <div class="section-header-form">
                        <h2><i class="fas fa-key"></i> 2. API Credentials</h2>
                        <button type="button" class="btn-help" onclick="showHelp('credentials')">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>

                    <div class="security-notice">
                        <i class="fas fa-shield-alt"></i>
                        <strong>Your credentials are secure:</strong> We never store your API keys.
                        They're encrypted and only used by your private AI assistant.
                    </div>

                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="telegramBotToken">
                                <i class="fab fa-telegram"></i> Telegram Bot Token
                                <span class="required">*</span>
                            </label>
                            <input type="password" id="telegramBotToken" name="telegramBotToken" required
                                   placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
                            <small class="help-text">
                                <a href="#" onclick="showCredentialHelp('telegram')">
                                    <i class="fas fa-question-circle"></i> How to get Telegram Bot Token?
                                </a>
                            </small>
                        </div>

                        <div class="form-group full-width" style="margin-bottom: 4px;">
                            <label>
                                <i class="fab fa-whatsapp"></i> Twilio Credentials
                                <small style="font-weight:normal; color: var(--text-gray);">(for WhatsApp &amp; SMS)</small>
                            </label>
                        </div>

                        <div class="form-group">
                            <label for="twilioAccountSid">Account SID</label>
                            <input type="password" id="twilioAccountSid" name="twilioAccountSid"
                                   placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                        </div>

                        <div class="form-group">
                            <label for="twilioAuthToken">Auth Token</label>
                            <input type="password" id="twilioAuthToken" name="twilioAuthToken"
                                   placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                        </div>

                        <div class="form-group full-width">
                            <label for="twilioPhoneNumber">Twilio Phone Number</label>
                            <input type="tel" id="twilioPhoneNumber" name="twilioPhoneNumber"
                                   placeholder="+1234567890">
                            <small class="help-text">
                                <a href="#" onclick="showCredentialHelp('twilio')">
                                    <i class="fas fa-question-circle"></i> How to get Twilio credentials?
                                </a>
                            </small>
                        </div>
                    </div>

                    <button type="button" class="btn-save-section" onclick="saveSection('credentials')">
                        <i class="fas fa-save"></i> Save Section
                    </button>
                </div>

                <!-- SECTION 2B: AI Budget -->
                <div class="form-section">
                    <div class="section-header-form">
                        <h2><i class="fas fa-wallet"></i> Monthly AI Budget</h2>
                        <button type="button" class="btn-help" onclick="showHelp('budget')">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>

                    <p class="section-description">
                        Set the monthly spending limit for AI API calls. When the budget is reached,
                        the AI will send a polite fallback message instead of using paid API calls.
                    </p>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="monthlyBudget">
                                <i class="fas fa-dollar-sign"></i> Monthly Budget (USD)
                            </label>
                            <input type="number" id="monthlyBudget" name="monthlyBudget"
                                   min="5" max="500" step="5" value="50"
                                   placeholder="50">
                            <small class="help-text">Default: $50/month. Alerts at 50%, 80%, and 100%.</small>
                        </div>
                    </div>

                    <button type="button" class="btn-save-section" onclick="saveSection('budget')">
                        <i class="fas fa-save"></i> Save Section
                    </button>
                </div>

                <!-- SECTION 3: Team & Contacts -->
                <div class="form-section">
                    <div class="section-header-form">
                        <h2><i class="fas fa-users"></i> 3. Team & Contacts</h2>
                        <button type="button" class="btn-help" onclick="showHelp('team')">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>

                    <p class="section-description">
                        Add people who help manage your properties. The AI will know who to contact for specific tasks.
                    </p>

                    <div id="teamMembersContainer">
                        <!-- Team members will be added here -->
                    </div>

                    <button type="button" class="btn-add" onclick="addTeamMember()">
                        <i class="fas fa-plus-circle"></i> Add Team Member
                    </button>

                    <button type="button" class="btn-save-section" onclick="saveSection('team')">
                        <i class="fas fa-save"></i> Save Section
                    </button>
                </div>

                <!-- SECTION 4: Property Details -->
                <div class="form-section">
                    <div class="section-header-form">
                        <h2><i class="fas fa-building"></i> 4. Property Details</h2>
                        <button type="button" class="btn-help" onclick="showHelp('properties')">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>

                    <p class="section-description">
                        Managed from the <a href="properties.html">Properties page</a>.
                        Add your properties there to track bookings and manage operations.
                    </p>

                    <a href="properties.html" class="btn-primary">
                        <i class="fas fa-building"></i> Go to Properties
                    </a>
                </div>

                <!-- SECTION 5: AI Assistant Configuration -->
                <div class="form-section">
                    <div class="section-header-form">
                        <h2><i class="fas fa-robot"></i> 5. AI Assistant Notes</h2>
                        <button type="button" class="btn-help" onclick="showHelp('ai')">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>

                    <p class="section-description">
                        Tell your AI assistant anything important it should know about your business,
                        preferences, or special situations.
                    </p>

                    <div class="form-group full-width">
                        <label for="aiNotes">
                            <i class="fas fa-comment-dots"></i> Special Instructions for AI
                        </label>
                        <textarea id="aiNotes" name="aiNotes" rows="6"
                                  placeholder="Example:
- Always offer early check-in if available
- We have a cat, so mention this to guests with allergies
- Cleaning crew arrives at 10 AM
- Never discount below $50/night
- Emergency maintenance contact: John 555-1234"></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label for="pricingRules">
                            <i class="fas fa-dollar-sign"></i> Pricing Rules
                        </label>
                        <textarea id="pricingRules" name="pricingRules" rows="4"
                                  placeholder="Example:
- Minimum price: $80/night
- Never go below 20% discount
- Weekend pricing +30%
- Monthly stays -15%"></textarea>
                    </div>

                    <button type="button" class="btn-save-section" onclick="saveSection('ai')">
                        <i class="fas fa-save"></i> Save Section
                    </button>
                </div>

                <!-- SECTION 5B: AI System Prompt (Live Workflow Editor) -->
                <div class="form-section" style="border-left: 3px solid #1877f2;">
                    <div class="section-header-form">
                        <h2><i class="fas fa-brain"></i> AI System Prompt (Live)</h2>
                        <span style="background:#1877f2;color:#fff;padding:2px 10px;border-radius:12px;font-size:11px;">Syncs to n8n</span>
                    </div>

                    <p class="section-description">
                        This is the core instruction set for your AI concierge. Changes here are pushed
                        directly to the live WF1 AI Gateway workflow. Edit how your AI behaves, responds,
                        and handles the booking flow.
                    </p>

                    <div class="form-group full-width">
                        <label for="systemPromptEditor">
                            <i class="fas fa-terminal"></i> System Prompt
                        </label>
                        <textarea id="systemPromptEditor" rows="12" style="font-family:monospace;font-size:13px;line-height:1.5;"
                                  placeholder="The AI concierge system prompt will appear here after first deployment. You can edit it to change how your AI assistant behaves."></textarea>
                        <small style="color:#8b8d91;">This controls the personality, rules, and booking flow of your AI assistant.</small>
                    </div>

                    <div class="form-group full-width">
                        <label for="pricingRulesEditor">
                            <i class="fas fa-tags"></i> Custom Pricing Rules (appended to prompt)
                        </label>
                        <textarea id="pricingRulesEditor" rows="4" style="font-family:monospace;font-size:13px;"
                                  placeholder="Example:
- Last-minute bookings (within 48h) get 10% discount
- Stays over 7 nights get 15% off
- Holiday weekends are non-negotiable pricing"></textarea>
                    </div>

                    <button type="button" id="saveSystemPromptBtn" class="btn-save-section" style="background:#1877f2;color:#fff;">
                        <i class="fas fa-cloud-upload-alt"></i> Save & Sync to AI
                    </button>
                </div>

                <!-- SECTION 6: Media & Resources -->
                <div class="form-section">
                    <div class="section-header-form">
                        <h2><i class="fas fa-image"></i> 6. Photos & Videos</h2>
                        <button type="button" class="btn-help" onclick="showHelp('media')">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>

                    <p class="section-description">
                        Provide Google Drive links to folders containing photos and videos
                        that the AI can send to guests when requested.
                    </p>

                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="propertyPhotosLink">
                                <i class="fab fa-google-drive"></i> Property Photos Folder
                            </label>
                            <input type="url" id="propertyPhotosLink" name="propertyPhotosLink"
                                   placeholder="https://drive.google.com/drive/folders/...">
                        </div>

                        <div class="form-group full-width">
                            <label for="propertyVideosLink">
                                <i class="fab fa-google-drive"></i> Property Videos Folder
                            </label>
                            <input type="url" id="propertyVideosLink" name="propertyVideosLink"
                                   placeholder="https://drive.google.com/drive/folders/...">
                        </div>

                        <div class="form-group full-width">
                            <label for="documentationLink">
                                <i class="fab fa-google-drive"></i> Guest Guides & Instructions
                            </label>
                            <input type="url" id="documentationLink" name="documentationLink"
                                   placeholder="https://drive.google.com/drive/folders/...">
                        </div>
                    </div>

                    <button type="button" class="btn-save-section" onclick="saveSection('media')">
                        <i class="fas fa-save"></i> Save Section
                    </button>
                </div>

                <!-- Final Activation Button -->
                <div class="activation-section">
                    <div class="activation-notice">
                        <i class="fas fa-rocket"></i>
                        <h3>Ready to Activate?</h3>
                        <p>Once you click "Activate AI Assistant", your workflows will be configured and deployed.
                           This may take 2-3 minutes.</p>
                    </div>

                    <button type="submit" class="btn-activate" id="activateBtn" disabled>
                        <i class="fas fa-power-off"></i> Activate AI Assistant
                    </button>

                    <p class="completion-requirement" id="completionRequirement">
                        <i class="fas fa-exclamation-triangle"></i>
                        Please complete all required sections before activating
                    </p>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal" id="loadingModal" style="display:none;">
        <div class="modal-content loading-modal">
            <div class="spinner"></div>
            <h2>Activating Your AI Assistant</h2>
            <p id="activationStatus">Configuring workflows...</p>
            <div class="progress-bar-loading">
                <div class="progress-fill-loading" id="activationProgress"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth-guard.js"></script>
    <script src="assets/js/fillup-form.js"></script>
    <script src="assets/js/sync.js"></script>
</body>
</html>
